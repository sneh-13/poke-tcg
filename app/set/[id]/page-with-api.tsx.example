'use client';

import { useState, useMemo, useEffect } from 'react';
import { useParams } from 'next/navigation';
import Link from 'next/link';
import { getCardsFromSet, getSetById } from '@/lib/pokemonTCGApi';
import { useTranslation } from '@/contexts/I18nContext';

export default function SetPage() {
  const params = useParams();
  const setId = params.id as string;
  const { t } = useTranslation();

  // State for API data
  const [set, setSet] = useState<any>(null);
  const [cards, setCards] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Filter states
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedRarities, setSelectedRarities] = useState<string[]>([]);
  const [selectedTypes, setSelectedTypes] = useState<string[]>([]);

  // Fetch set and cards on mount
  useEffect(() => {
    async function fetchData() {
      try {
        setLoading(true);

        // Example set IDs from the API:
        // 'base1' - Base Set
        // 'base2' - Jungle
        // 'base3' - Fossil
        // 'xy1' - XY Base Set
        // 'sm1' - Sun & Moon Base Set
        // 'swsh1' - Sword & Shield Base Set
        // 'sv1' - Scarlet & Violet Base Set

        const [setData, cardsData] = await Promise.all([
          getSetById(setId),
          getCardsFromSet(setId)
        ]);

        setSet(setData);
        setCards(cardsData);
        setError(null);
      } catch (err) {
        console.error('Error fetching data:', err);
        setError('Failed to load set data. Please try again.');
      } finally {
        setLoading(false);
      }
    }

    fetchData();
  }, [setId]);

  const filteredCards = useMemo(() => {
    let filtered = cards;

    if (searchQuery) {
      filtered = filtered.filter((card) =>
        card.name.toLowerCase().includes(searchQuery.toLowerCase())
      );
    }

    if (selectedRarities.length > 0) {
      filtered = filtered.filter((card) =>
        card.rarity && selectedRarities.includes(card.rarity.id || card.rarity)
      );
    }

    if (selectedTypes.length > 0) {
      filtered = filtered.filter((card) =>
        card.supertype && selectedTypes.includes(card.supertype.toLowerCase())
      );
    }

    return filtered;
  }, [cards, searchQuery, selectedRarities, selectedTypes]);

  const toggleRarity = (rarity: string) => {
    setSelectedRarities((prev) =>
      prev.includes(rarity) ? prev.filter((r) => r !== rarity) : [...prev, rarity]
    );
  };

  const toggleType = (type: string) => {
    setSelectedTypes((prev) =>
      prev.includes(type) ? prev.filter((t) => t !== type) : [...prev, type]
    );
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-poke-blue mx-auto mb-4"></div>
          <p className="text-gray-600">Loading cards...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <p className="text-red-600 mb-4">{error}</p>
          <Link href="/" className="text-poke-blue hover:underline">
            Back to sets
          </Link>
        </div>
      </div>
    );
  }

  if (!set) {
    return <div className="p-8">Set not found</div>;
  }

  // Get unique rarities from cards
  const availableRarities = Array.from(new Set(cards.map(c => c.rarity).filter(Boolean)));

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="flex max-w-[1600px] mx-auto">
        {/* Sidebar */}
        <aside className="sticky top-[70px] left-0 h-[calc(100vh-70px)] w-[280px] glass-sidebar p-6 overflow-y-auto hidden lg:block">
          <div className="mb-6">
            <input
              type="text"
              placeholder={t('set.search_cards')}
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-poke-blue"
            />
          </div>

          {/* Rarity Filter */}
          <div className="mb-6">
            <h3 className="text-sm font-semibold text-charcoal mb-3">Rarity</h3>
            <div className="space-y-2">
              {availableRarities.map((rarity) => (
                <label key={rarity} className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={selectedRarities.includes(rarity)}
                    onChange={() => toggleRarity(rarity)}
                    className="w-4 h-4 text-poke-blue border-gray-300 rounded focus:ring-poke-blue"
                  />
                  <span className="text-sm text-gray-700 capitalize">{rarity}</span>
                </label>
              ))}
            </div>
          </div>

          {/* Type Filter */}
          <div className="mb-6">
            <h3 className="text-sm font-semibold text-charcoal mb-3">Type</h3>
            <div className="space-y-2">
              {['pokemon', 'trainer', 'energy'].map((type) => (
                <label key={type} className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={selectedTypes.includes(type)}
                    onChange={() => toggleType(type)}
                    className="w-4 h-4 text-poke-blue border-gray-300 rounded focus:ring-poke-blue"
                  />
                  <span className="text-sm text-gray-700 capitalize">{type}</span>
                </label>
              ))}
            </div>
          </div>
        </aside>

        {/* Main Content */}
        <main className="flex-1 p-8">
          <Link href="/" className="text-poke-blue hover:underline mb-4 inline-block">
            {t('set.back_to_sets')}
          </Link>

          <div className="mb-8">
            <h1 className="text-4xl font-bold text-charcoal mb-2">{set.name}</h1>
            <p className="text-gray-600">
              {set.series} • {set.releaseDate} • {set.printedTotal || set.total} cards
            </p>
          </div>

          {/* Cards Grid */}
          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
            {filteredCards.map((card) => (
              <Link
                key={card.id}
                href={`/card/${setId}/${card.id}`}
                className="glass-card p-3 hover:shadow-hover transition-all group"
              >
                <div className="aspect-[2/3] bg-gray-100 rounded-lg mb-2 overflow-hidden">
                  {card.images?.small ? (
                    <img
                      src={card.images.small}
                      alt={card.name}
                      className="w-full h-full object-contain"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center">
                      <span className="text-sm text-gray-400">{card.number}</span>
                    </div>
                  )}
                </div>
                <h3 className="text-sm font-semibold text-charcoal group-hover:text-poke-blue transition-colors line-clamp-1">
                  {card.name}
                </h3>
                <p className="text-xs text-gray-500 capitalize">{card.rarity}</p>
              </Link>
            ))}
          </div>

          {filteredCards.length === 0 && (
            <div className="text-center py-12">
              <p className="text-gray-500">No cards found matching your filters.</p>
            </div>
          )}
        </main>
      </div>
    </div>
  );
}
